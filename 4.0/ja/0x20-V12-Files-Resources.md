# V12: ファイルおよびリソース検証要件

## 管理目標

検証されるアプリケーションが以下の上位レベルの要件を満たしていることを確認します。

* 信頼できないファイルデータはそれに応じてセキュアに処理する必要があります。
* 信頼できない情報源から取得した信頼できないファイルデータはウェブルートの外部に、かつ制限されたパーミッションで保存されています。

## V12.1 ファイルアップロード要件

zip 爆弾はペネトレーションテスト技法を使用して大いにテスト可能ですが、慎重な手動テストによる設計と開発への配慮を促し、サービス拒否状態となる自動ペネトレーションテストや未熟な手動ペネトレーションテストを避けるために、L2 以上とみなされています。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.1.1** | アプリケーションはストレージをいっぱいにしたり、サービス拒否を引き起こす可能性のある大きなファイルを受け付けないことを検証します。 | ✓ | ✓ | ✓ | 400 |
| **12.1.2** | 圧縮ファイルが "zip 爆弾" つまりファイルストレージ容量の上限を超える巨大なファイルに展開される小さな入力ファイルでないかどうか確認することを検証します。 |  | ✓ | ✓ | 409 |
| **12.1.3** | 一人のユーザーが非常に多くのファイルや極端に大きなファイルでストレージをいっぱいにすることができないように、ファイルサイズクォータとユーザーあたりの最大ファイル数が適用されていることを検証します。 |  | ✓ | ✓ | 770 |

## V12.2 ファイル整合性要件

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.2.1** | 信頼できない情報源から取得されたファイルはファイルのコンテンツに基づいて予想される種類であることを確認されていることを検証します。 |  | ✓ | ✓ | 434 |

## V12.3 ファイル実行要件

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.3.1** | パストラバーサルから保護するために、ユーザーが送信したファイル名メタデータがシステムやフレームワークファイルにより直接使用されていないこと、および URL API が使用されていることを検証します。 | ✓ | ✓ | ✓ | 22 |
| **12.3.2** | ローカルファイルの開示、作成、更新、削除 (LFI) を防ぐために、ユーザーが送信したファイル名メタデータが確認または無視されていることを検証します。 | ✓ | ✓ | ✓ | 73 |
| **12.3.3** | リモートファイルインクルージョン (RFI) やサーバーサイドリクエストフォージェリ (SSRF) によるリモートファイルの開示や実行を防ぐために、ユーザーが送信したファイル名メタデータが確認または無視されていることを検証します。 | ✓ | ✓ | ✓ | 98 |
| **12.3.4** | JSON, JSONP, URL パラメータでユーザーが送信したファイル名を確認または無視することにより、アプリケーションが Reflective File Download (RFD) に対して保護していることを検証します。レスポンスの Content-Type ヘッダは text/plain に設定し、Content-Disposition は固定ファイル名であるべきです。 | ✓ | ✓ | ✓ | 641 |
| **12.3.5** | OS コマンドインジェクションから保護するために、信頼できないファイルメタデータがシステム API やライブラリで直接使用されていないことを検証します。 | ✓ | ✓ | ✓ | 78 |
| **12.3.6** | 未検証のコンテンツ配信ネットワーク、JavaScript ライブラリ、node npm ライブラリ、サーバーサイド DLL など、信頼できないソースからの機能がアプリケーションに含まれて実行されていないことを検証します。 |  | ✓ | ✓ | 829 |

## V12.4 ファイルストレージ要件

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.4.1** | 信頼できないソースから取得したファイルが、限られたパーミッションで、できれば強力なバリデーションで、ウェブルートの外側に保存されていることを検証します。 | ✓ | ✓ | ✓ | 922 |
| **12.4.2** | 信頼できないソースから取得したファイルが、既知の悪意のあるコンテンツのアップロードを防ぐためにウィルス対策スキャナによりスキャンされていることを検証します。 | ✓ | ✓ | ✓ | 509 |

## V12.5 ファイルダウンロード要件

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.5.1** | 意図しない情報漏洩やソースコード漏洩を防ぐために、ウェブ層が特定のファイル拡張子を持つファイルのみを処理するように設定されていることを検証します。例えば、バックアップファイル (.bak など) 、一時作業ファイル (.swp など) 、圧縮ファイル (.zip, .tar.gz など) やエディタで一般的に使用されるその他の拡張子は、必要でない限りブロックすべきです。 | ✓ | ✓ | ✓ | 552 |
| **12.5.2** | アップロードされたファイルへの直接のリクエストが HTML/JavaScript コンテンツとして決して実行されないことを検証します。 | ✓ | ✓ | ✓ | 434 |

## V12.6 SSRF 保護要件

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.6.1** | ウェブサーバーまたはアプリケーションサーバーが、サーバーが要求を送信したりデータやファイルをロードしたりできるリソースやシステムの許可リストで構成されていることを検証します。 | ✓ | ✓ | ✓ | 918 |

## 参考情報

詳細については、以下も参照してください。

* [File Extension Handling for Sensitive Information](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)
* [Reflective file download by Oren Hafif](https://www.trustwave.com/Resources/SpiderLabs-Blog/Reflected-File-Download---A-New-Web-Attack-Vector/)
* [OWASP Third Party JavaScript Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Third_Party_Javascript_Management_Cheat_Sheet.html)
