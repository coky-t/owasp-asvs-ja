# V5 バリデーション、サニタイゼーション、エンコーディング

## 管理目標

最も一般的な Web アプリケーションセキュリティ脆弱性は、出力エンコーディング、クエリのパラメータ化、あるいはその他の出力処理防御を行わずに、安全でないコンテキストで信頼できないコンテンツを使用することです。この脆弱性は、クロスサイトスクリプティング (XSS) 、SQL インジェクション、OS コマンドインジェクション、テンプレートインジェクション、ログインジェクション、LDAP インジェクションなど、Web アプリケーションにおける重大な脆弱性の多くにつながります。

現代の Web アプリケーションアーキテクチャでは、出力エンコーディングがこれまで以上に重要です。特定のシナリオでは堅牢な入力バリデーションを提供することは困難であるため、パラメータ化されたクエリ、自動エスケープテンプレートフレームワークなどの安全な API の使用や、注意深く選択された出力エンコーディングがアプリケーションのセキュリティにとって重要です。

## V5.1 入力バリデーション

入力は HTML フォームフィールド、REST リクエスト、URL パラメータ、HTTP ヘッダ、Cookie、ディスク上のファイル、データベース、外部 API など、さまざまなソースからもたらされます。

ポジティブ許可リストと強いデータ型付けを使用して、入力バリデーション制御を適切に実装すると、アプリが受け取ることを期待するデータの種類に関するビジネスロジック制御や機能上の期待の重要な実施を提供します。ビジネスロジック制御では、特定の入力が 100 未満の数値であるべきとするかもしれません。機能上の期待では、特定の数値は特定の閾値以下であるべきです。その数値は特定のループが実行すべき回数を管理するため、高い数値は過剰な処理やサービス拒否状態につながる可能性があります。

入力バリデーションは依然として価値のあるセキュリティ衛生を提供するため、可能な限りすべての入力に適用すべきです。しかし、入力バリデーションは一般的に特定の攻撃を防ぐことを意図しておらず、したがって完全なセキュリティ戦略でははないため、潜在的に危険なコンテキストで入力が使用される際には常に、サンドボックス化、サニタイゼーション、エンコーディング、パラメータ化も利用すべきです。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **5.1.1** | [修正] 特にアプリケーションフレームワークがリクエストパラメータ (クエリ文字列, ボディパラメータ, cookie, ヘッダ) のソースについて判別していない場合、アプリケーションが HTTP パラメータ汚染攻撃を防御している。 | ✓ | ✓ | ✓ | 235 |
| **5.1.2** | [10.4.4 へ移動] | | | | |
| **5.1.3** | [修正] すべての入力は、その入力に対するビジネス上や機能上の期待を強制するために、許可された値、パターン、範囲のリストに照らして、ポジティブバリデーションを使用して検証される。 | ✓ | ✓ | ✓ | 20 |
| **5.1.4** | [修正, 5.1.7 へ分割] 期待される構造を備えたデータ構造は事前に定義されたルールに従って検証される。 | ✓ | ✓ | ✓ | 20 |
| **5.1.5** | [修正, 50.7.1 へ分割] アプリケーションは、宛先が許可リストに記載されているもののみ、アプリケーション URL から直接別の URL にユーザーを自動的にリダイレクトしている。 | ✓ | ✓ | ✓ | 601 |
| **5.1.6** | [追加] 信頼できない入力は Cookie (JWT の一部として含める) に含める前に長さが検証され、Cookie 名と値の長さを合わせて 4096 バイトを超えていない。 | | ✓ | ✓ | |
| **5.1.7** | [追加, 5.1.4 から分割] アプリケーションは、関連するデータ項目の組み合わせが事前に定義されたルールに従って妥当であることを確保している。 | ✓ | ✓ | ✓ | 20 |
| **5.1.8** | [追加] アプリケーションは、HTTP リクエストヘッダフィールド内のユーザ制御の入力がサーバの最大ヘッダフィールドサイズ制限 (通常は 4kB または 8kB) を超えていないことを検証し、クライアントベースのサービス拒否攻撃を防止している。 | | ✓ | ✓ | |

## V5.2 サニタイゼーションおよびサンドボックス

信頼できないコンテンツを安全でないコンテキストで使用することに対する理想的な保護は、コンテキスト固有のエンコーディングやエスケープを使用することです。これにより、安全でないコンテンツと同じ意味を維持しながら、この特定のコンテキストで安全に使用できるようになります。これについては、次のセクションで詳しく説明します。

これが不可能な場合、他の選択肢としてサニタイゼーションとサンドボックス化があります。サニタイゼーションは、潜在的に危険な文字やコンテンツを削除します。場合によっては、入力の意味を変えるかもしれませんが、セキュリティ上の理由から選択の余地がないこともあります。サンドボックス化は、潜在的に危険な操作を封じ込め、セキュリティ上の脆弱性が生じても、より広範なアプリケーションを危険にさらすことがないようにします。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **5.2.1** | [修正] WYSIWYG エディタなどからの信頼できない HTML 入力はすべて、よく知られた安全な HTML サニタイゼーションライブラリまたはフレームワーク機能を使用して適切にサニタイズされている。 | ✓ | ✓ | ✓ | 116 |
| **5.2.2** | [修正] 潜在的に危険なコンテキストに渡されるデータは、事前にサニタイズして、このコンテキストにとって安全な文字だけを許可したり、長すぎる入力を切り詰めるなどの安全対策を実施している。 | ✓ | ✓ | ✓ | 138 |
| **5.2.3** | SMTP インジェクションや IMAP インジェクションから保護するため、ユーザ入力をメールシステムに渡す前にアプリケーションがサニタイズしている。 | ✓ | ✓ | ✓ | 147 |
| **5.2.4** | [修正] アプリケーションが eval() や Spring Expression Lanugage (SpEL) などの他の動的コード実行機能の使用を回避している。代替手段がない場合には、含まれているユーザ入力を実行する前にサニタイズまたはサンドボックス化する必要がある。 | ✓ | ✓ | ✓ | 95 |
| **5.2.5** | [修正] アプリケーションは信頼できない入力に基づくテンプレートの作成を許可しないことで、テンプレートインジェクション攻撃から保護している。代替手段がない場合、テンプレート作成中に動的に含まれるすべての信頼できない入力はサニタイズまたは厳密に妥当性確認する必要がある。 | ✓ | ✓ | ✓ | 94 |
| **5.2.6** | [文法] ファイル名や URL 入力フィールドなどの信頼できないデータや HTTP ファイルメタデータを妥当性確認またはサニタイズする、およびプロトコル、ドメイン、パス、ポートの許可リストを使用することにより、アプリケーションが SSRF 攻撃から保護している。 | ✓ | ✓ | ✓ | 918 |
| **5.2.7** | アプリケーションはユーザが提供する Scalable Vector Graphics (SVG) スクリプト可能コンテンツ、特にインラインスクリプトによる XSS や foreignObject に関するものをサニタイズ、無効化、またはサンドボックス化する。 | ✓ | ✓ | ✓ | 159 |
| **5.2.8** | アプリケーションは、マークダウン、CSS や XSL スタイルシート、BBCode などのユーザが提供するスクリプト可能コンテンツまたは式テンプレート言語コンテンツをサニタイズ、無効化、またはサンドボックス化する。 | ✓ | ✓ | ✓ | 94 |
| **5.2.9** | [追加] アプリケーションはスラッシュを使用して、正規表現で使用される特殊文字を正確にエスケープし、制御文字として誤って解釈されないようにしている。 | ✓ | ✓ | ✓ | 624 |
| **5.2.10** | [追加] 正規表現に指数関数的なバックトラッキングを引き起こす要素がないことを検証している。また、信頼できない入力をサニタイズし、ReDoS 攻撃や Runaway Regex 攻撃を軽減している。 | ✓ | ✓ | ✓ | 1333 |
| **5.2.11** | [追加] アプリケーションは Java Naming and Directory Interface (JNDI) クエリで使用する前に信頼できない入力を適切にサニタイズし、JNDI を可能な限り安全に構成して JNDI インジェクション攻撃を防いでいる。 | ✓ | ✓ | ✓ | 917 |
| **5.2.12** | [追加] アプリケーションは memcache に送信する前にコンテンツをサニタイズし、インジェクション攻撃を防いでいる。 | | ✓ | ✓ | |
| **5.2.13** | [修正, 5.4.2 から移動] 使用時に、予期しないあるいは悪意のある方法で解決される可能性のあるフォーマット文字列は、処理される前にサニタイズされている。 | | ✓ | ✓ | 134 |

注: SVG フォーマットはほとんどすべてのコンテキストで ECMA スクリプトを明示的に許可するため、SVG XSS ベクトルを完全にブロックすることはできないかもしれません。SVG のアップロードが必要な場合、アップロードされたファイルを text/plain として提供するか、ユーザが提供する別のコンテキストドメインを使用して、XSS がアプリケーションを乗っ取るのを防ぐことを強くお勧めします。

## V5.3 出力エンコーディングおよびインジェクション防止

潜在的に危険なコンテキストの近くあるいは隣接する場所での出力エンコーディングやエスケープは、あらゆるアプリケーションのセキュリティにとって重要です。通常、出力エンコーディングとエスケープは永続化されるのではなく、適切なインタプリタですぐに使用できるように出力を安全にするために使用されます。これをあまりに早い段階で行おうとすると、不正なコンテンツとなったり、エンコーディングやエスケープが効かなくなることがあります。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **5.3.1** | [修正, 5.3.13 へ分割] HTTP レスポンス、HTML ドキュメント、XML ドキュメントの出力エンコーディングは、メッセージやドキュメント構造の変更を避けるために、HTML 要素、HTML 属性、HTML コメント、CSS、HTTP ヘッダに関連する文字をエンコードするなど、要求されるコンテキストに関連している。 | ✓ | ✓ | ✓ | 116 |
| **5.3.2** | [削除, 14.4.1 と重複] | | | | |
| **5.3.3** | [修正, 50.5.4 へ分割] 出力エンコーディングまたはエスケープは、JavaScript コンテンツ (JSON を含む) を動的に構築するときに使用され、メッセージやドキュメント構造の変更を回避している (JavaScript および JSON インジェクションを回避するため)。 | ✓ | ✓ | ✓ | |
| **5.3.4** | [修正] データ選択またはデータベースクエリ (SQL, HQL, NoSQL, Cypherなど) がパラメータ化クエリ、ORM、エンティティフレームワークを使用している、または SQL インジェクションや他のデータベースインジェクション攻撃から保護されている。これはストアドプロシージャを記述する際にも考慮している。 | ✓ | ✓ | ✓ | 89 |
| **5.3.5** | [削除, 5.3.4 と重複] | | | | |
| **5.3.6** | [削除, 5.3.3 と重複] | | | | |
| **5.3.7** | アプリケーションが LDAP インジェクション脆弱性から保護する、または LDAP インジェクションを防ぐために特定のセキュリティ管理策が実装されている。 | ✓ | ✓ | ✓ | 90 |
| **5.3.8** | アプリケーションが OS コマンドインジェクションから保護する、およびオペレーティングシステムがパラメータ化 OS クエリを使用するか、コンテキストに応じたコマンドライン出力エンコーディングを使用する。 | ✓ | ✓ | ✓ | 78 |
| **5.3.9** | [削除, 12.3.1 へマージ] | | | | |
| **5.3.10** | [修正] アプリケーションは、クエリパラメータ化やコンパイル済みクエリを使用することで、XPath インジェクション攻撃から保護されている。 | ✓ | ✓ | ✓ | 643 |
| **5.3.11** | [追加] アプリケーションが CSV インジェクションや数式インジェクションから保護されている。アプリケーションは CSV ファイルをエクスポートする際に RFC4180 2.6 および 2.7 で定義されているエスケープ規則に従う必要がある。アプリケーションは CSV ファイルや xls, xlsx, odf などのその他のスプレッドシート形式をエクスポートする際に、フィールドの最初の文字が '=', '+', '-', '@', '\t' (タブ), '\00' (ヌル文字) などの特殊文字である場合、シングルクォートを使用してエスケープする必要がある。 | ✓ | ✓ | ✓ | 1236 |
| **5.3.12** | [追加] LaTeX プロセッサは ("--shell-escape" フラグを使用しないなど) 安全に構成されており、LaTeX インジェクション攻撃を防ぐためにコマンドの許可リストを使用している。 | | ✓ | ✓ | |
| **5.3.13** | [追加, 5.3.1 から分割] URL を動的に構築する場合、信頼できないデータはそのコンテキストに応じてエンコードされている (例: クエリやパスパラメータの URL エンコーディングや base64url エンコーディング)。安全な URL プロトコルのみが許可されるようにしている (例: javascript: や data: を許可しない)。 | ✓ | ✓ | ✓ | 116 |

注意: パラメータ化クエリや SQL エスケープの使用は必ずしも十分ではありません。テーブル名や列名、ORDER BY などはエスケープできません。これらのフィールドにエスケープされたユーザ指定データを含めると、クエリの失敗または SQL インジェクションを引き起こします。

## V5.4 メモリ、文字列、アンマネージコード

以下の要件はアプリケーションがシステム言語またはアンマネージコードを使用する場合にのみ適用されます。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **5.4.1** | アプリケーションがメモリセーフな文字列、安全なメモリコピーおよびポインタ演算を使用して、スタック、バッファ、またはヒープオーバーフローを検出または防止する。 | | ✓ | ✓ | 120 |
| **5.4.2** | [5.2.13 へ移動] | | | | |
| **5.4.3** | 整数オーバーフローを防ぐために符号、範囲、および入力バリデーション技法が使用されている。 | | ✓ | ✓ | 190 |

## V5.5 逆シリアル化防止

何らかの保存または転送された表現から実際のアプリケーションオブジェクトへのデータの変換 (逆シリアル化) はこれまでさまざまなコードインジェクション脆弱性の原因となってきました。このような問題を回避するには、このプロセスを慎重かつ安全に実行することが重要です。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **5.5.1** | [削除, 不正確] | | | | |
| **5.5.2** | アプリケーションが XML パーサーを最も制限の厳しい構成のみを使用するよう適切に制限し、XML 外部エンティティ (XML eXternal Entity, XXE) 攻撃を防止するために外部エンティティの解決などの危険な機能を無効にする。 | ✓ | ✓ | ✓ | 611 |
| **5.5.3** | [修正, 1.5.2 からマージ] 信頼できないウライアントと通信するときに逆シリアル化が使用される場合、入力は安全に処理されている。たとえば、逆シリアル化攻撃を防ぐために、オブジェクトタイプの許可リストのみを許可するか、クライアントが逆シリアル化先のオブジェクトタイプを定義できないようにしている。 | ✓ | ✓ | ✓ | 502 |
| **5.5.4** | [削除, 5.2.4 と重複] | | | | |
| **5.5.5** | [修正, 13.1.1 から移動, レベル L1 > L2] JSON 相互運用性の脆弱性や、さまざまな URI やファイルの解析動作がリモートファイルインクルージョン (RFI) やサーバサイドリクエストフォージェリ (SSRF) 攻撃で悪用されるような問題を回避するために、同じデータ型に対してアプリケーションで使用されるさまざまなパーサー (JSON パーサー、XML パーサー、URL パーサーなど) は一貫した方法で解析を実行し、同じエンコードメカニズムを使用する。 | | ✓ | ✓ | 436 |

## V5.6 バリデーションおよびサニタイゼーションアーキテクチャ

上記のセクションでは、セキュリティの脆弱性を回避するために、安全でないコンテンツを安全に処理するためのシンタックス固有またはインタプリタ固有の要件を示しました。このセクションの要件は、この処理が行われるべき順序と場所をカバーしています。また、二重エンコーディング問題を防ぐために、データが保存されるときは常に、エンコードまたはエスケープされた状態 (HTML エンコーディングなど) ではなく、元の状態で保存されることを保証することも目的としています。

<!--
以下の場合、要件はここに属します。

  * 入力バリデーション、サニタイゼーション、エンコーディングアーキテクチャ
  * 入力バリデーション、サニタイゼーション、エンコーディング処理 (順序)

以下の場合、要件はここに属しません。

  * 構文固有または明確な入力バリデーション、サニタイゼーション、エンコーディング要件

再構成: 段落の最初の章に移動します
-->

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **5.6.1** | [追加] 入力は一度だけ標準形式にデコードまたはアンエスケープされ、その形式でエンコードされたデータが期待される場合にのみデコードされ、これは入力をさらに処理する前に行われる。たとえば、入力バリデーションやサニタイゼーションの後には実行されない。 | ✓ | ✓ | ✓ | 174 |
| **5.6.2** | [修正, 1.5.3 から移動, レベル L2 > L1] アプリケーションは信頼できるサービスレイヤで入力バリデーションを実行するように設計されている。クライアントサイドのバリエーションはユーザービリティを向上するが、セキュリティコントロールとしては依存してはならない。 | ✓ | ✓ | ✓ | 602 |
| **5.6.3** | [修正, 1.5.4 から移動] アプリケーションはそれが意図されているインタプリタまたはインタプリタ自体によって使用される前の最終ステップとして、出力エンコーディングおよびエスケープを実行する。 | | ✓ | ✓ | 116 |

## 参考情報

詳しくは以下の情報を参照してください。

* [OWASP Testing Guide 4.0: Input Validation Testing](https://owasp.org/www-project-web-security-testing-guide/v41/4-Web_Application_Security_Testing/07-Input_Validation_Testing/README.html)
* [OWASP Cheat Sheet: Input Validation](https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html)
* [OWASP Testing Guide 4.0: Testing for HTTP Parameter Pollution](https://owasp.org/www-project-web-security-testing-guide/v41/4-Web_Application_Security_Testing/07-Input_Validation_Testing/04-Testing_for_HTTP_Parameter_Pollution.html)
* [OWASP LDAP Injection Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/LDAP_Injection_Prevention_Cheat_Sheet.html)
* [OWASP Testing Guide 4.0: Client-Side Testing](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/11-Client-side_Testing/README)
* [OWASP Cross Site Scripting Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
* [OWASP DOM Based Cross Site Scripting Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/DOM_based_XSS_Prevention_Cheat_Sheet.html)
* [OWASP Java Encoding Project](https://owasp.org/owasp-java-encoder/)
* [DOMPurify - Client-side HTML Sanitization Library](https://github.com/cure53/DOMPurify)
* [XML External Entity (XXE) Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)

自動エスケープの詳細については、以下を参照してください。

* [Reducing XSS by way of Automatic Context-Aware Escaping in Template Systems](https://googleonlinesecurity.blogspot.com/2009/03/reducing-xss-by-way-of-automatic.html)
* [AngularJS Strict Contextual Escaping](https://docs.angularjs.org/api/ng/service/$sce)
* [AngularJS ngBind](https://docs.angularjs.org/api/ng/directive/ngBind)
* [Angular Sanitization](https://angular.io/guide/security#sanitization-and-security-contexts)
* [Angular Security](https://angular.io/guide/security)
* [ReactJS Escaping](https://reactjs.org/docs/introducing-jsx.html#jsx-prevents-injection-attacks)
* [Improperly Controlled Modification of Dynamically-Determined Object Attributes](https://cwe.mitre.org/data/definitions/915.html)

逆シリアル化やパースの問題の詳細については、以下を参照してください。

* [OWASP Deserialization Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html)
* [OWASP Deserialization of Untrusted Data Guide](https://owasp.org/www-community/vulnerabilities/Deserialization_of_untrusted_data)
* [An Exploration of JSON Interoperability Vulnerabilities](https://bishopfox.com/blog/json-interoperability-vulnerabilities)
* [Orange Tsai - A New Era of SSRF Exploiting URL Parser In Trending Programming Languages](https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf)
